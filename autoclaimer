--[[ 
    ADVANCED BOOTH SEARCHER (AUTO-START)
    - Auto-Teleports to BasicBooth
    - Simulates 3s Hold (Visual + Trigger)
    - Monitors Console for 'YourBooth'
    - Draggable UI, Auto-Start, Anti-Softlock
]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LogService = game:GetService("LogService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Configuration
local SEARCH_DELAY = 1 -- Time to wait after holding E to check logs
local STABILIZE_DELAY = 0.8 -- Time to wait after teleporting before pressing E
local UI_TOGGLE_KEY = Enum.KeyCode.RightControl

-- State
local isSearching = true -- Auto-start enabled
local boothFound = false

--------------------------------------------------------------------------------
-- GUI CREATION
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoBoothGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = PlayerGui -- Forced to PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -80)
MainFrame.Size = UDim2.new(0, 260, 0, 160)
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(60, 60, 60)
UIStroke.Thickness = 2
UIStroke.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, 0, 0, 35)
Title.Font = Enum.Font.GothamBold
Title.Text = "AUTO CLAIMER"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 16
Title.Parent = MainFrame

local StatusLabel = Instance.new("TextLabel")
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.35, 0)
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.Text = "SEARCHING..."
StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 50) -- Orange
StatusLabel.TextSize = 14
StatusLabel.Parent = MainFrame

local SubLabel = Instance.new("TextLabel")
SubLabel.BackgroundTransparency = 1
SubLabel.Position = UDim2.new(0, 0, 0.6, 0)
SubLabel.Size = UDim2.new(1, 0, 0, 20)
SubLabel.Font = Enum.Font.Gotham
SubLabel.Text = "Logs scanned for 'YourBooth'"
SubLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
SubLabel.TextSize = 11
SubLabel.Parent = MainFrame

local CloseInfo = Instance.new("TextLabel")
CloseInfo.BackgroundTransparency = 1
CloseInfo.Position = UDim2.new(0, 0, 0.85, 0)
CloseInfo.Size = UDim2.new(1, 0, 0, 15)
CloseInfo.Text = "RightCtrl to Toggle UI"
CloseInfo.TextColor3 = Color3.fromRGB(80, 80, 80)
CloseInfo.Font = Enum.Font.Gotham
CloseInfo.TextSize = 10
CloseInfo.Parent = MainFrame

--------------------------------------------------------------------------------
-- DRAGGABLE LOGIC
--------------------------------------------------------------------------------
local dragging, dragInput, dragStart, startPos
local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
end)
UserInputService.InputChanged:Connect(function(input) if input == dragInput and dragging then update(input) end end)

--------------------------------------------------------------------------------
-- SEARCH LOGIC
--------------------------------------------------------------------------------

-- 1. Log Monitor
LogService.MessageOut:Connect(function(message, messageType)
    if isSearching and string.find(message, "YourBooth") then
        boothFound = true
        isSearching = false
        StatusLabel.Text = "BOOTH CLAIMED!"
        StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 100) -- Green
        
        -- Stop any lingering interaction
        local char = LocalPlayer.Character
        if char then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then hrp.Anchored = false end -- Unanchor if we were anchored
        end
    end
end)

local function getBooths()
    local folder = Workspace:FindFirstChild("BoothModels")
    if not folder then return {} end
    local booths = {}
    for _, v in pairs(folder:GetChildren()) do
        if v.Name == "BasicBooth" then
            table.insert(booths, v)
        end
    end
    return booths
end

-- Main Loop
task.spawn(function()
    while isSearching and not boothFound do
        local booths = getBooths()
        
        if #booths > 0 then
            local randomBooth = booths[math.random(1, #booths)]
            local prompt = randomBooth:FindFirstChildWhichIsA("ProximityPrompt", true)

            if randomBooth.PrimaryPart and prompt then
                local char = LocalPlayer.Character
                local hrp = char and char:FindFirstChild("HumanoidRootPart")
                
                if hrp then
                    -- 1. Reset Interactions (Fix for "Start holding too early")
                    prompt:InputHoldEnd() 
                    
                    -- 2. Teleport
                    StatusLabel.Text = "Teleporting..."
                    hrp.CFrame = randomBooth.PrimaryPart.CFrame * CFrame.new(0, 0, -3.5)
                    hrp.Velocity = Vector3.zero -- Stop momentum
                    
                    -- 3. Stabilize (Wait for teleport to finish and prompt to load)
                    task.wait(STABILIZE_DELAY)
                    
                    -- 4. Start Holding
                    if isSearching and not boothFound then -- Re-check safety
                        StatusLabel.Text = "Holding E..."
                        
                        -- Start Visual
                        prompt:InputHoldBegin()
                        
                        -- Wait Duration
                        local duration = prompt.HoldDuration
                        if duration < 1 then duration = 1 end -- Safety minimum
                        task.wait(duration) 
                        
                        -- 5. Finish Holding (Trigger)
                        prompt:InputHoldEnd() -- Visual End
                        
                        -- Attempt Executor Trigger if available, otherwise just rely on HoldEnd logic
                        if fireproximityprompt then
                            fireproximityprompt(prompt)
                        end
                        
                        -- 6. Wait for Log Check
                        StatusLabel.Text = "Checking..."
                        task.wait(SEARCH_DELAY)
                        
                        -- 7. Reset again before leaving
                        prompt:InputHoldEnd()
                    end
                end
            end
        else
            StatusLabel.Text = "No BasicBooths found..."
            task.wait(2)
        end
        
        -- Retry loop buffer
        task.wait(0.2)
    end
end)

--------------------------------------------------------------------------------
-- TOGGLE & CLEANUP
--------------------------------------------------------------------------------

UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == UI_TOGGLE_KEY then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

script.Destroying:Connect(function()
    isSearching = false
    ScreenGui:Destroy()
end)
