--[[ 
    ADVANCED AUTO-CHATTER UTILITY
    - Draggable UI
    - Anti-Softlock (Error handling, pcalls, nil checks)
    - Supports both Legacy Chat and TextChatService automatically
    - Toggleable UI (RightControl)
    - Clean Dark Theme
]]

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Configuration
local UI_TOGGLE_KEY = Enum.KeyCode.RightControl -- Key to open/close
local MIN_DELAY = 0.5 -- Minimum delay to prevent crashing/spam filtering

-- State Variables
local isRunning = false
local currentLoopTask = nil
local currentIndex = 1

--------------------------------------------------------------------------------
-- GUI CREATION (Pure Code, No External Assets)
--------------------------------------------------------------------------------

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoChatterGUI"
ScreenGui.ResetOnSpawn = false -- Keeps UI alive after death
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Try to parent to CoreGui for extra protection, fallback to PlayerGui
pcall(function()
    ScreenGui.Parent = CoreGui
end)
if not ScreenGui.Parent then
    ScreenGui.Parent = PlayerGui
end

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -125)
MainFrame.Size = UDim2.new(0, 300, 0, 280)
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(60, 60, 60)
UIStroke.Thickness = 2
UIStroke.Parent = MainFrame

-- Title Bar
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "Title"
TitleLabel.BackgroundTransparency = 1
TitleLabel.Size = UDim2.new(1, 0, 0, 30)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.Text = "Auto Chatter"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 16
TitleLabel.Parent = MainFrame

-- Phrase Input
local PhraseBox = Instance.new("TextBox")
PhraseBox.Name = "PhraseInput"
PhraseBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
PhraseBox.BorderSizePixel = 0
PhraseBox.Position = UDim2.new(0.05, 0, 0.15, 0)
PhraseBox.Size = UDim2.new(0.9, 0, 0.5, 0)
PhraseBox.Font = Enum.Font.Gotham
PhraseBox.PlaceholderText = "Enter phrases here...\nSeparate by new lines."
PhraseBox.Text = ""
PhraseBox.TextColor3 = Color3.fromRGB(220, 220, 220)
PhraseBox.TextSize = 14
PhraseBox.TextXAlignment = Enum.TextXAlignment.Left
PhraseBox.TextYAlignment = Enum.TextYAlignment.Top
PhraseBox.ClearTextOnFocus = false
PhraseBox.MultiLine = true
PhraseBox.Parent = MainFrame

local BoxCorner = Instance.new("UICorner")
BoxCorner.CornerRadius = UDim.new(0, 6)
BoxCorner.Parent = PhraseBox

-- Interval Input
local IntervalLabel = Instance.new("TextLabel")
IntervalLabel.BackgroundTransparency = 1
IntervalLabel.Position = UDim2.new(0.05, 0, 0.68, 0)
IntervalLabel.Size = UDim2.new(0.4, 0, 0.1, 0)
IntervalLabel.Font = Enum.Font.GothamMedium
IntervalLabel.Text = "Cooldown (s):"
IntervalLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
IntervalLabel.TextXAlignment = Enum.TextXAlignment.Left
IntervalLabel.Parent = MainFrame

local IntervalBox = Instance.new("TextBox")
IntervalBox.Name = "IntervalInput"
IntervalBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
IntervalBox.Position = UDim2.new(0.45, 0, 0.68, 0)
IntervalBox.Size = UDim2.new(0.5, 0, 0.1, 0)
IntervalBox.Font = Enum.Font.Gotham
IntervalBox.Text = "2.5"
IntervalBox.TextColor3 = Color3.fromRGB(255, 255, 255)
IntervalBox.Parent = MainFrame

local IntervalCorner = Instance.new("UICorner")
IntervalCorner.CornerRadius = UDim.new(0, 6)
IntervalCorner.Parent = IntervalBox

-- Toggle Button
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Name = "ToggleBtn"
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 100)
ToggleBtn.Position = UDim2.new(0.05, 0, 0.82, 0)
ToggleBtn.Size = UDim2.new(0.9, 0, 0.12, 0)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.Text = "START"
ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtn.TextSize = 16
ToggleBtn.Parent = MainFrame

local BtnCorner = Instance.new("UICorner")
BtnCorner.CornerRadius = UDim.new(0, 6)
BtnCorner.Parent = ToggleBtn

-- Notification Label (Footer)
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Position = UDim2.new(0, 0, 1, 5)
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Press RightCtrl to Hide"
StatusLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 12
StatusLabel.Parent = MainFrame

--------------------------------------------------------------------------------
-- DRAGGABLE LOGIC
--------------------------------------------------------------------------------
local dragging, dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

--------------------------------------------------------------------------------
-- CHAT SYSTEM DETECTION & LOGIC
--------------------------------------------------------------------------------

local function sendMessage(msg)
    -- Sanity check: Don't send empty strings
    if not msg or msg:gsub("%s+", "") == "" then return end

    -- Anti-Softlock: Wrap in pcall to prevent script erroring if chat service fails
    pcall(function()
        if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
            -- NEW Chat System
            local generalChannel = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
            if generalChannel then
                generalChannel:SendAsync(msg)
            end
        else
            -- LEGACY Chat System
            local event = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
            if event then
                local sayRequest = event:FindFirstChild("SayMessageRequest")
                if sayRequest then
                    sayRequest:FireServer(msg, "All")
                end
            end
        end
    end)
end

--------------------------------------------------------------------------------
-- MAIN LOOP LOGIC
--------------------------------------------------------------------------------

local function stopLoop()
    isRunning = false
    if currentLoopTask then
        task.cancel(currentLoopTask)
        currentLoopTask = nil
    end
    ToggleBtn.Text = "START"
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 100) -- Green
end

local function startLoop()
    if isRunning then return end
    
    -- Parse Phrases
    local rawText = PhraseBox.Text
    local phrases = rawText:split("\n")
    local cleanPhrases = {}
    
    -- Filter empty lines
    for _, v in pairs(phrases) do
        if v:gsub("%s+", "") ~= "" then
            table.insert(cleanPhrases, v)
        end
    end
    
    if #cleanPhrases == 0 then
        ToggleBtn.Text = "EMPTY LIST!"
        task.wait(1)
        ToggleBtn.Text = "START"
        return
    end

    -- Parse Interval
    local delayTime = tonumber(IntervalBox.Text)
    if not delayTime or delayTime < MIN_DELAY then
        delayTime = MIN_DELAY
        IntervalBox.Text = tostring(MIN_DELAY)
    end

    isRunning = true
    ToggleBtn.Text = "STOP"
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(170, 50, 50) -- Red
    
    currentLoopTask = task.spawn(function()
        while isRunning do
            -- Anti-Softlock: Check if index is out of bounds
            if currentIndex > #cleanPhrases then
                currentIndex = 1
            end
            
            local msg = cleanPhrases[currentIndex]
            
            -- Send
            sendMessage(msg)
            
            -- Increment
            currentIndex = currentIndex + 1
            
            -- Wait (using task.wait for precision)
            task.wait(delayTime)
        end
    end)
end

ToggleBtn.MouseButton1Click:Connect(function()
    if isRunning then
        stopLoop()
    else
        startLoop()
    end
end)

--------------------------------------------------------------------------------
-- UI TOGGLE (KEYBIND)
--------------------------------------------------------------------------------

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == UI_TOGGLE_KEY then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

-- Cleanup on script destroy (Anti-Softlock)
local function cleanup()
    stopLoop()
    ScreenGui:Destroy()
end

-- If the LocalScript is disabled or destroyed, clean up UI
script.Destroying:Connect(cleanup)
